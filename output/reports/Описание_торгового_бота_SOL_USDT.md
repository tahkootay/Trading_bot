# Подробное описание торгового бота SOL/USDT

## Общий обзор системы

Это профессиональный внутридневной торговый бот, разработанный для торговли парой SOL/USDT на бирже Bybit. Бот использует машинное обучение, технический анализ и микроструктуру рынка для генерации высоковероятных торговых сигналов с целью захвата движений цены от $2 и более.

### Цель проекта
Захватывать 3-7 движений цены от $2+ ежедневно на паре SOL/USDT с контролируемым риском.

---

## 1. Архитектура и блоки системы

### 1.1 Основные компоненты

#### **Data Collector (Сбор данных)**
- **Расположение**: `src/data_collector/`
- **Функция**: Сбор рыночных данных в реальном времени с биржи Bybit
- **Компоненты**:
  - `bybit_client.py` - HTTP клиент для работы с API Bybit
  - `market_data_collector.py` - Сбор и обработка рыночных данных

#### **Feature Engine (Обработка данных и индикаторы)**
- **Расположение**: `src/feature_engine/`
- **Функция**: Вычисление технических индикаторов и признаков для ML модели
- **Компоненты**:
  - `technical_indicators.py` - Расчет технических индикаторов (EMA, RSI, MACD, ADX и др.)
  - `market_regime.py` - Анализ рыночного режима
  - `order_flow.py` - Анализ потока ордеров
  - `volume_profile.py` - Профиль объемов

#### **ML Models (Машинное обучение)**
- **Расположение**: `src/models/`
- **Функция**: Предсказание направления движения цены
- **Компоненты**:
  - `ml_models.py` - Основные ML модели (XGBoost, LightGBM)
  - `ml_predictor.py` - Предсказания с ансамблем моделей
  - `ml_models_mock.py` - Заглушка для тестирования

#### **Signal Generator (Генератор сигналов)**
- **Расположение**: `src/signal_generator/`
- **Функция**: Создание торговых сигналов на основе ML предсказаний и технического анализа
- **Компоненты**:
  - `signal_generator.py` - Основная логика генерации сигналов
  - `setup_detector.py` - Детектор торговых сетапов
  - `entry_filters.py` - Фильтры входа в позицию

#### **Risk Manager (Управление рисками)**
- **Расположение**: `src/risk_manager/`
- **Функция**: Контроль рисков и расчет размера позиции
- **Компоненты**:
  - `risk_manager.py` - Основная логика управления рисками
  - `position_sizer.py` - Расчет размера позиции
  - `adaptive_position_sizer.py` - Адаптивный расчет размера позиции

#### **Execution (Исполнение ордеров)**
- **Расположение**: `src/execution/`
- **Функция**: Исполнение торговых ордеров на бирже
- **Компоненты**:
  - `order_manager.py` - Управление ордерами
  - `order_executor.py` - Исполнение ордеров
  - `trade_manager.py` - Управление сделками

#### **Notifications (Уведомления)**
- **Расположение**: `src/notifications/`
- **Функция**: Отправка уведомлений через Telegram
- **Статус**: Подготовлена структура, но реализация не завершена

### 1.2 Взаимодействие блоков

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│  Data Collector │ -> │ Feature Engine  │ -> │   ML Models     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       v
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Execution     │ <- │  Risk Manager   │ <- │ Signal Generator│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                                       │
                                                       v
                                            ┌─────────────────┐
                                            │  Notifications  │
                                            └─────────────────┘
```

**Поток данных:**
1. **Data Collector** собирает данные с биржи
2. **Feature Engine** обрабатывает данные и вычисляет индикаторы
3. **ML Models** делают предсказания на основе признаков
4. **Signal Generator** создает торговые сигналы
5. **Risk Manager** проверяет сигналы и рассчитывает размер позиции
6. **Execution** исполняет ордера на бирже
7. **Notifications** отправляет уведомления о событиях

---

## 2. Хранение собранных данных

### 2.1 Форматы данных

#### **CSV файлы (текущая реализация)**
- **Расположение**: `data/`
- **Структура**: 
  ```
  timestamp,open,high,low,close,volume,turnover
  2025-08-10 11:31:00,179.68,179.86,179.64,179.86,11985.6,2154298.988
  ```
- **Временные рамки**: 1m, 5m, 15m, 1h
- **Типы**: real (реальные данные), testnet (тестовые данные)

#### **Metadata файлы**
- **Формат**: JSON
- **Содержимое**: Информация о периодах, количестве записей, последних обновлениях

### 2.2 Планируемые базы данных (конфигурация готова)

#### **PostgreSQL**
- **Назначение**: Хранение исторических данных
- **URL**: `postgresql://user:password@localhost:5432/trading_bot`
- **Статус**: Настройка подготовлена, но не активна

#### **Redis**
- **Назначение**: Кэширование часто используемых данных
- **URL**: `redis://localhost:6379/0`
- **Применение**: Кэш технических индикаторов, промежуточные результаты

#### **InfluxDB**
- **Назначение**: Хранение временных рядов и метрик
- **URL**: `http://localhost:8086`
- **Применение**: Мониторинг производительности, системные метрики

---

## 3. Система бэктестирования

### 3.1 Основной скрипт
- **Файл**: `scripts/enhanced_backtest.py`
- **Класс**: `EnhancedBacktestEngine`

### 3.2 Принципы работы

#### **Последовательная обработка данных**
- ✅ **Реализована постепенная подача данных**
- Бэктест обрабатывает данные свеча за свечой
- На каждом шаге доступны только исторические данные
- **Исключен lookahead bias** - бот не видит будущие цены

#### **Процесс бэктестирования**
```python
for i in range(lookback_period, len(data)):
    # Текущая свеча
    current_candle = data.iloc[i]
    
    # Исторические данные до текущего момента
    historical_data = data.iloc[:i+1]
    
    # Расчет индикаторов на исторических данных
    features = calculate_features(historical_data)
    
    # Генерация сигнала (без знания будущего)
    signal = generate_signal(features)
    
    # Обработка сигнала
    process_signal(signal)
```

#### **Реалистичная симуляция**
- Учет комиссий (0.1%)
- Учет проскальзывания (0.05%)
- Эмуляция задержек исполнения
- Моделирование частичного исполнения ордеров

### 3.3 Доступные команды
```bash
# Базовый бэктест
python scripts/enhanced_backtest.py --symbol SOLUSDT --days 7

# Сохранение результатов в JSON
python scripts/enhanced_backtest.py --save-results

# Создание HTML отчета
python scripts/generate_detailed_report.py
```

### 3.4 Результаты бэктестирования
- **JSON файлы**: Детальные метрики в `Output/backtest_results_*.json`
- **HTML отчеты**: Визуальные отчеты в `Output/SOL_USDT_Backtest_Report_*.html`
- **Метрики**: Sharpe ratio, максимальная просадка, процент прибыльных сделок

---

## 4. Торговый бот и подключение к testnet

### 4.1 Основной файл
- **Файл**: `src/main.py`
- **Класс**: `TradingBot`

### 4.2 Возможности подключения

#### **Testnet Bybit**
- ✅ **Полностью поддерживается**
- Конфигурация через `config.exchange.testnet = True`
- Отдельные скрипты для testnet:
  - `scripts/setup_testnet.py` - настройка testnet
  - `scripts/collect_testnet_data.py` - сбор тестовых данных
  - `scripts/run_testnet_backtest.py` - бэктест на testnet данных

#### **Режимы работы**
1. **Paper Trading** - симуляция без реальных ордеров
2. **Testnet** - реальные ордера на тестовой сети
3. **Live Trading** - реальные ордера на основной сети

#### **Команды запуска**
```bash
# Paper trading
python -m src.main --paper-trading

# Testnet
python -m src.main --config config/testnet.yaml

# Live trading  
python -m src.main --config config/prod.yaml
```

### 4.3 Безопасность
- Встроенные лимиты риска
- Аварийное закрытие позиций
- Graceful shutdown при получении сигнала
- Логирование всех операций

---

## 5. Telegram бот и уведомления

### 5.1 Конфигурация
- **Токен**: `TELEGRAM_BOT_TOKEN` в `.env`
- **Chat ID**: `TELEGRAM_CHAT_ID` в `.env`
- **Пример**: 
  ```env
  TELEGRAM_BOT_TOKEN=your_telegram_bot_token
  TELEGRAM_CHAT_ID=your_telegram_chat_id
  ```

### 5.2 Назначение уведомлений

#### **Критические события**
- Открытие/закрытие позиций
- Срабатывание стоп-лоссов
- Превышение лимитов риска
- Ошибки подключения к бирже
- Аварийная остановка бота

#### **Информационные сообщения**
- Генерация торговых сигналов
- Изменения в конфигурации
- Обновления ML моделей
- Heartbeat сообщения

### 5.3 Текущий статус
- Конфигурация настроена
- Интеграция в код подготовлена
- **Требуется**: Создание фактического Telegram бота и получение токена

---

## 6. Конфигурация баз данных

### 6.1 Назначение каждой БД

#### **PostgreSQL** - Основное хранилище
- **Цель**: Долгосрочное хранение исторических данных
- **Данные**: 
  - История свечей
  - Выполненные сделки
  - Торговые сигналы
  - Результаты бэктестов
- **Обязательность**: Опционально, сейчас используются CSV файлы

#### **Redis** - Кэш и быстрый доступ
- **Цель**: Кэширование часто используемых данных
- **Данные**:
  - Рассчитанные технические индикаторы
  - Текущие позиции
  - Последние цены
  - Конфигурация в runtime
- **Обязательность**: Опционально, повышает производительность

#### **InfluxDB** - Временные ряды и мониторинг
- **Цель**: Мониторинг производительности системы
- **Данные**:
  - Метрики производительности
  - Задержки исполнения
  - Использование ресурсов
  - Статистика торговли
- **Обязательность**: Опционально, для продвинутого мониторинга

### 6.2 Настройка и использование

#### **Текущее состояние**
- Все БД **опциональны**
- Система работает с CSV файлами
- Конфигурация подготовлена для подключения БД

#### **Команды настройки**
```bash
# Запуск всех сервисов через Docker
docker-compose up -d

# Проверка подключения
python scripts/test_connection.py

# Миграция данных в PostgreSQL (если нужно)
python scripts/migrate_data.py
```

#### **Когда настраивать БД**
1. **PostgreSQL** - при больших объемах исторических данных (>1GB)
2. **Redis** - при высокой нагрузке и необходимости быстрого доступа
3. **InfluxDB** - при необходимости детального мониторинга

---

## 7. Практические рекомендации

### 7.1 Быстрый старт
```bash
# 1. Скачивание данных
python scripts/collect_data.py --symbol SOLUSDT --days 7

# 2. Бэктест
python scripts/enhanced_backtest.py --symbol SOLUSDT --days 7

# 3. Создание отчета
python scripts/generate_detailed_report.py

# 4. Paper trading
python -m src.main --paper-trading
```

### 7.2 Переход на live trading
1. Получить API ключи от Bybit
2. Настроить `.env` файл
3. Протестировать на testnet
4. Запустить в режиме paper trading
5. Постепенно увеличивать размер позиций

### 7.3 Мониторинг
- Логи в консоли и файлах
- HTML отчеты в папке `Output/`
- Telegram уведомления (после настройки)
- Heartbeat каждые 5 минут

---

## 8. Архитектурные особенности

### 8.1 Async/Await
- Вся система построена на асинхронном программировании
- Параллельная обработка данных
- Неблокирующие операции с API

### 8.2 Модульность
- Каждый компонент независим
- Легкая замена и тестирование модулей
- Четкое разделение ответственности

### 8.3 Безопасность
- Никогда не торгует без стоп-лосса
- Лимиты дневных потерь
- Аварийная остановка при критических ошибках
- Логирование всех операций

### 8.4 Масштабируемость
- Готовность к работе с несколькими парами
- Поддержка различных временных рамок
- Возможность добавления новых стратегий

---

## Заключение

Торговый бот представляет собой комплексную систему для автоматической торговли с использованием современных технологий машинного обучения и управления рисками. Система спроектирована с акцентом на безопасность и может работать как в тестовом, так и в продакшн режиме.

**Ключевые преимущества:**
- Полноценный бэктестинг без lookahead bias
- Гибкая конфигурация рисков
- Поддержка testnet для безопасного тестирования
- Модульная архитектура для легкого расширения
- Comprehensive logging и мониторинг

**Статус готовности:**
- ✅ Бэктестинг - готов
- ✅ Paper trading - готов  
- ✅ Testnet trading - готов
- ⚠️ Live trading - требует настройки API ключей
- ⚠️ Базы данных - опциональны, конфигурация готова
- ⚠️ Telegram - требует создания бота